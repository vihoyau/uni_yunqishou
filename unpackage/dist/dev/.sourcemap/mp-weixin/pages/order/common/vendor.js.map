{"version":3,"sources":["uni-app:///shopro/pay/index.js"],"names":["ShoproPay","payment","order","platform","$platform","get","payMehod","getPayMethod","payMethod","wxOfficialAccountPay","copyPayLink","walletPay","wxMiniProgramPay","wechatPay","aliPay","wechatWapPay","goToPayLink","that","Promise","resolve","reject","params","order_sn","uni","getStorageSync","openid","then","res","code","data","showModal","title","content","success","confirm","wechat","bind","prepay","result","wxsdk","wxpay","pay_data","errMsg","payResult","url","match","reg","RegExp","newUrl","replace","domain","store","state","shopro","config","shop","encodeURIComponent","id","window","location","href","requestPayment","provider","fail","err","console","log","confirmText","setClipboardData","$u","toast","orderInfo","JSON","parse","resultType","$Router","path","query","orderId","type","payState"],"mappings":"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","file":"pages/order/common/vendor.js","sourcesContent":["import $http from '@/shopro/request/index'\n\n\n\nimport wechat from '@/shopro/wechat/wechat'\nimport {\n\trouter as $Router\n} from '@/shopro/router/index.js'\nimport store from '@/shopro/store';\nimport $platform from '@/shopro/platform';\n\n\nexport default class ShoproPay {\n\n\n\t//\t\t\t\t\t\twxOfficialAccount\t\t\twxMiniProgram\t\t\tApp\t\t\t\t\t\tH5\n\t// \t\t\twechat\t\t\t公众号JSSDK支付\t\t\t\t小程序支付\t\t\t微信开放平台支付\t\t\tH5网页支付\n\t//\t\t\talipay\t\t\t复制网址\t\t\t\t\t\t复制网址\t\t\t\t支付宝开放平台支付\t\t    直接跳转链接\n\t// \t\t\twallet\t\t\tv\t\t\t\t\t\t\tv\t\t\t\t\tv\t\t\t\t\t\tv\n\n\n\tconstructor(payment, order) {\n\t\tthis.payment = payment;\n\t\tthis.order = order;\n\t\tthis.platform = $platform.get();\n\t\tlet payMehod = this.getPayMethod();\n\t\tpayMehod();\n\n\t}\n\n\tgetPayMethod() {\n\t\tvar payMethod = {\n\t\t\t'wxOfficialAccount': {\n\t\t\t\t'wechat': () => {\n\t\t\t\t\tthis.wxOfficialAccountPay()\n\t\t\t\t},\n\t\t\t\t'alipay': () => {\n\t\t\t\t\tthis.copyPayLink()\n\t\t\t\t},\n\t\t\t\t'wallet': () => {\n\t\t\t\t\tthis.walletPay()\n\t\t\t\t}\n\t\t\t},\n\t\t\t'wxMiniProgram': {\n\t\t\t\t'wechat': () => {\n\t\t\t\t\tthis.wxMiniProgramPay()\n\t\t\t\t},\n\t\t\t\t'alipay': () => {\n\t\t\t\t\tthis.copyPayLink()\n\t\t\t\t},\n\t\t\t\t'wallet': () => {\n\t\t\t\t\tthis.walletPay()\n\t\t\t\t}\n\t\t\t},\n\t\t\t'App': {\n\t\t\t\t'wechat': () => {\n\t\t\t\t\tthis.wechatPay()\n\t\t\t\t},\n\t\t\t\t'alipay': () => {\n\t\t\t\t\tthis.aliPay()\n\t\t\t\t},\n\t\t\t\t'wallet': () => {\n\t\t\t\t\tthis.walletPay()\n\t\t\t\t},\n\t\t\t},\n\t\t\t'H5': {\n\t\t\t\t'wechat': () => {\n\t\t\t\t\tthis.wechatWapPay()\n\t\t\t\t},\n\t\t\t\t'alipay': () => {\n\t\t\t\t\tthis.goToPayLink()\n\t\t\t\t},\n\t\t\t\t'wallet': () => {\n\t\t\t\t\tthis.walletPay()\n\t\t\t\t},\n\t\t\t},\n\t\t}\n\t\treturn payMethod[this.platform][this.payment];\n\t}\n\n\n\n\t// 预支付\n\tprepay() {\n\t\tlet that = this;\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet that = this;\n\t\t\tlet params = {\n\t\t\t\torder_sn: that.order.order_sn,\n\t\t\t\tpayment: that.payment\n\t\t\t}\n\t\t\tif (uni.getStorageSync('openid')) {\n\t\t\t\tparams.openid = uni.getStorageSync('openid');\n\t\t\t}\n\t\t\t$http('money.prepay', params, '支付中').then(res => {\n\t\t\t\tif (res.code === 1) {\n\t\t\t\t\tres.data === 'no_openid' ?\n\t\t\t\t\t\tuni.showModal({\n\t\t\t\t\t\t\ttitle: '微信支付',\n\t\t\t\t\t\t\tcontent: '请先绑定微信再使用微信支付',\n\t\t\t\t\t\t\tsuccess: function(res) {\n\t\t\t\t\t\t\t\tif (res.confirm) {\n\t\t\t\t\t\t\t\t\twechat.bind();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}) :\n\t\t\t\t\t\tresolve(res);\n\n\t\t\t\t}\n\t\t\t})\n\t\t});\n\t}\n\n\n\t// 微信H5支付\n\tasync wxOfficialAccountPay() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\twxsdk.wxpay(result.data.pay_data, (res) => {\n\t\t\tres.errMsg == \"chooseWXPay:ok\" ? that.payResult('success') : that.payResult('fail')\n\t\t});\n\n\t}\n\n\t//浏览器微信支付\n\tasync wechatWapPay() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\tif (result.code === 1) {\n\t\t\tvar url = result.data.pay_data.match(/url\\=\\'(\\S*)\\'/);\n\t\t\tlet reg = new RegExp('&amp;', 'g') //g代表全部\n\t\t\tlet newUrl = url[1].replace(reg, '&');\n\t\t\tlet domain = store.state.shopro.config.shop.domain; //域名需要https\n\t\t\tlet params = encodeURIComponent(\n\t\t\t\t`${domain}pages/order/payment/result?orderId=${that.order.id}&type=${that.payment}`)\n\t\t\twindow.location.href = newUrl + '&redirect_url=' + params;\n\t\t}\n\t}\n\n\t// 微信小程序支付\n\tasync wxMiniProgramPay() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\tuni.requestPayment({\n\t\t\tprovider: 'wxpay',\n\t\t\t...result.data.pay_data,\n\t\t\tsuccess: res => {\n\t\t\t\tthat.payResult('success')\n\t\t\t},\n\t\t\tfail: err => {\n\t\t\t\tconsole.log('支付取消或者失败:', err);\n\t\t\t\terr.errMsg !== \"requestPayment:fail cancel\" && that.payResult('fail')\n\t\t\t}\n\t\t});\n\t}\n\n\t// 余额支付\n\tasync walletPay() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\tresult.code === 1 && that.payResult('success')\n\t}\n\n\t// 支付宝复制链接支付\n\tasync copyPayLink() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\tif (result.code === 1) {\n\t\t\t//引入showModal 点击确认 复制链接；\n\t\t\tuni.showModal({\n\t\t\t\ttitle: '支付宝支付',\n\t\t\t\tcontent: '复制链接到外部浏览器',\n\t\t\t\tconfirmText: '复制链接',\n\t\t\t\tsuccess: (res) => {\n\t\t\t\t\tif (res.confirm) {\n\t\t\t\t\t\tuni.setClipboardData({\n\t\t\t\t\t\t\tdata: result.data.pay_data,\n\t\t\t\t\t\t\tsuccess: function(data) {\n\t\t\t\t\t\t\t\tthat.$u.toast('已复制到剪切板');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\t// 支付链接\n\tasync goToPayLink() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\tif (result.code === 1) {\n\t\t\twindow.location = result.data.pay_data;\n\t\t}\n\t}\n\n\t// 支付宝支付\n\tasync aliPay() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\tif (result.code === 1) {\n\t\t\tuni.requestPayment({\n\t\t\t\tprovider: 'alipay',\n\t\t\t\torderInfo: result.data.pay_data, //支付宝订单数据\n\t\t\t\tsuccess: res => {\n\t\t\t\t\tthat.payResult('success')\n\t\t\t\t},\n\t\t\t\tfail: err => {\n\t\t\t\t\tconsole.log('支付取消或者失败:', err);\n\t\t\t\t\terr.errMsg !== \"requestPayment:fail cancel\" && that.payResult('fail')\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t// 微信支付\n\tasync wechatPay() {\n\t\tlet that = this;\n\t\tlet result = await this.prepay();\n\t\tif (result.code === 1) {\n\t\t\tuni.requestPayment({\n\t\t\t\tprovider: 'wxpay',\n\t\t\t\torderInfo: JSON.parse(result.data.pay_data), //微信订单数据(官方说是string。实测为object)\n\t\t\t\tsuccess: res => {\n\t\t\t\t\tthat.payResult('success')\n\t\t\t\t},\n\t\t\t\tfail: err => {\n\t\t\t\t\terr.errMsg !== \"requestPayment:fail cancel\" && that.payResult('fail')\n\t\t\t\t\tconsole.log('支付取消或者失败:', err);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\n\t// 支付结果跳转,success:成功，fail:失败\n\tpayResult(resultType) {\n\t\tconst that = this;\n\t\t$Router.replace({\n\t\t\tpath: '/pages/order/payment/result',\n\t\t\tquery: {\n\t\t\t\torderId: that.order.id,\n\t\t\t\ttype: that.payment, //重新支付的时候使用\n\t\t\t\tpayState: resultType\n\t\t\t}\n\t\t});\n\t}\n\n}\n"],"sourceRoot":""}